<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ª©ng V√≠a May M·∫Øn</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .game-container {
            width: 100%;
            max-width: 400px;
            height: 600px;
            background: linear-gradient(180deg, #87CEEB 0%, #98FB98 100%);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        /* Frame 1 - M√†n ch√†o */
        .welcome-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #FFD700, #FFA500, #FF6347);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            z-index: 10;
        }

        .welcome-title {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        .welcome-subtitle {
            font-size: 18px;
            color: #fff;
            margin-bottom: 40px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .play-btn {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }

        .play-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.3);
        }

        /* Frame 2 - Game play */
        .game-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        .game-header {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .game-info {
            display: flex;
            gap: 20px;
            font-size: 16px;
            color: #666;
        }

        .progress-bar {
            width: 100px;
            height: 6px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 3px;
            transition: width 0.1s ease;
            width: 100%;
        }

        .game-area {
            position: relative;
            width: 100%;
            height: calc(100% - 80px);
            overflow: hidden;
        }

        .clouds {
            position: absolute;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><circle cx="20" cy="10" r="8" fill="white" opacity="0.6"/><circle cx="40" cy="8" r="6" fill="white" opacity="0.4"/><circle cx="70" cy="12" r="7" fill="white" opacity="0.5"/></svg>') repeat-x;
            animation: float 20s linear infinite;
        }

        @keyframes float {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100px); }
        }

        .lucky-item {
            position: absolute;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #FFD700, #FFA500);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 5;
            transition: all 0.1s ease-out;
            will-change: transform;
        }

        .lucky-item.has-image {
            border: none;
            border-radius: 0;
            background-color: transparent;
        }

        .lucky-item.has-image::before {
            content: '';
        }

        .lucky-item::before {
            content: 'üçÄ';
        }

        @keyframes fallFromTop {
            from {
                transform: translateY(-50px) rotate(0deg);
            }
            to {
                transform: translateY(650px) rotate(360deg);
            }
        }

        @keyframes fallFromLeft {
            from {
                transform: translateX(-50px) translateY(100px) rotate(0deg);
            }
            to {
                transform: translateX(450px) translateY(650px) rotate(360deg);
            }
        }

        @keyframes fallFromRight {
            from {
                transform: translateX(50px) translateY(100px) rotate(0deg);
            }
            to {
                transform: translateX(-450px) translateY(650px) rotate(360deg);
            }
        }

        @keyframes fallFromCenter {
            0% {
                transform: translateY(200px) translateX(0) scale(0) rotate(0deg);
                opacity: 0;
            }
            20% {
                transform: translateY(200px) translateX(0) scale(1) rotate(72deg);
                opacity: 1;
            }
            100% {
                transform: translateY(650px) translateX(0) scale(1) rotate(360deg);
                opacity: 1;
            }
        }

        @keyframes fallZigzagFromLeft {
            0% {
                transform: translateX(-50px) translateY(50px) rotate(0deg);
            }
            25% {
                transform: translateX(100px) translateY(200px) rotate(90deg);
            }
            50% {
                transform: translateX(300px) translateY(350px) rotate(180deg);
            }
            75% {
                transform: translateX(200px) translateY(500px) rotate(270deg);
            }
            100% {
                transform: translateX(400px) translateY(650px) rotate(360deg);
            }
        }

        @keyframes fallZigzagFromRight {
            0% {
                transform: translateX(50px) translateY(50px) rotate(0deg);
            }
            25% {
                transform: translateX(-100px) translateY(200px) rotate(90deg);
            }
            50% {
                transform: translateX(-300px) translateY(350px) rotate(180deg);
            }
            75% {
                transform: translateX(-200px) translateY(500px) rotate(270deg);
            }
            100% {
                transform: translateX(-400px) translateY(650px) rotate(360deg);
            }
        }

        @keyframes fallSpiralFromCenter {
            0% {
                transform: translateY(150px) translateX(0) rotate(0deg) scale(0.5);
            }
            25% {
                transform: translateY(250px) translateX(80px) rotate(90deg) scale(1);
            }
            50% {
                transform: translateY(350px) translateX(0) rotate(180deg) scale(1.2);
            }
            75% {
                transform: translateY(450px) translateX(-80px) rotate(270deg) scale(0.8);
            }
            100% {
                transform: translateY(650px) translateX(0) rotate(360deg) scale(1);
            }
        }

        .basket {
            position: absolute;
            bottom: 20px;
            width: 90px;
            height: 70px;
            background: linear-gradient(45deg, #8B4513, #D2691E);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 0 0 45px 45px;
            border: 3px solid #654321;
            transition: left 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .basket.has-image {
            border: none;
            border-radius: 0;
            background-color: transparent;
        }

        .basket.has-image::before {
            content: '';
        }

        .basket::before {
            content: 'üß∫';
        }

        /* Frame 3 - K·∫øt qu·∫£ */
        .result-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .result-title {
            font-size: 24px;
            color: #fff;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .caught-count {
            font-size: 48px;
            color: #FFD700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .gift-box {
            width: 120px;
            height: 120px;
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            border-radius: 10px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            animation: giftPulse 2s infinite;
        }

        @keyframes giftPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .gift-name {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .result-buttons {
            display: flex;
            gap: 15px;
        }

        .result-btn {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .result-btn:hover {
            transform: translateY(-2px);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .hidden {
            display: none !important;
        }

        /* Audio Controls */
        .audio-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 20;
        }

        .audio-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            margin-left: 5px;
            transition: background 0.3s;
        }

        .audio-btn:hover {
            background: rgba(255, 255, 255, 1);
        }

        .audio-btn.muted {
            background: rgba(255, 100, 100, 0.8);
        }
        @media (max-width: 480px) {
            .game-container {
                max-width: 100%;
                height: 100vh;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Audio Controls -->
        <div class="audio-controls">
            <button class="audio-btn" id="musicBtn" onclick="toggleMusic()" title="B·∫≠t/T·∫Øt nh·∫°c n·ªÅn">üéµ</button>
            <button class="audio-btn" id="soundBtn" onclick="toggleSound()" title="B·∫≠t/T·∫Øt √¢m thanh">üîä</button>
        </div>

        <!-- Audio Elements -->
        <audio id="bgMusic" loop>
            <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaAjOD0fPTgjEGKXzJ8OGVSA0PVqzn77BTGAg4n91txmUjAzWI2u/JbC0ELI7L8teMOgcYa7zl4Z1QEQ04ltryxnMpAy+BzvHaiDkICGS57OOeUAwLUKXh8LVjGgU3k9n1unQpBSOFzPLaizsIGGi869uuWicEO4zY8sp2KwUtgM/z3Y4+CRZhturqpVITC0ml4/K4YRsGNpTZ8sh+LAMnfs/z4Y1ACRVhtuvmr1YfCUOh4N22ZCEENIzU8sp5LQUrhs/z3Y4/CBZhturrpVMSC0mk5PC2YRsFNpPY88h9KgMnfs/z4Y1ACRVgtO3enVURDEeq5O2zjCwAL4PN89uNOwkUZLzu3Z9SFAxQpujxx3MoAy+BzvLaiDgIF2W869quWScEO4zY8sV5KwYpc9Dy3Yk8BhljufDgq1oYCExh49a8ZiAENJPV8ch8KwQmft3z4Y1ACRZfu+vanlQRDUmj4/O2YxsGNpLY88h9KgMnfM/z4Y1ACRVgtu3dnVUSC0ul4/K5YRsGNpLY88h9KgMnfM/z4Y1ACRZftubenVQSC0ul4/K5YRsGNpLY88h9KgMnfM/z4Y1ACRZftubenVQSC0ul4/K5YRsGNpLY88h9KgQIRgAAAA=" type="audio/wav">
        </audio>
        <audio id="catchSound">
            <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAAABhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaAjOD0fPTgjEGKXzJ8OGVSA0PVqzn77BTGAg4n91txmUjAzWI2u/JbC0ELI7L8teMOgcYa7zl4Z1QEQ04ltryxnMpAy+BzvHaiDkICGS57OOeUAwLUKXh8LVjGgU3k9n1unQpBSOFzPLaizsIGGi869uuWicEO4zY8sp2KwUtgM/z3Y4+CRZhturqpVITC0ml4/K4YRsGNpTZ8sh+LAMnfs/z4Y1ACRVhtuvmr1YfCUOh4N22ZCEENIzU8sp5LQUrhs/z3Y4/CBZhturrpVMSC0mk5PC2YRsFNpPY88h9KgMnfs/z4Y1ACRVgtO3enVURDEeq5O2zjCwAL4PN89uNOwkUZLzu3Z9SFAxQpujxx3MoAy+BzvLaiDgIF2W869quWScEO4zY8sV5KwYpc9Dy3Yk8BhljufDgq1oYCExh49a8ZiAENJPV8ch8KwQmft3z4Y1ACRZfu+vanlQRDUmj4/O2YxsGNpLY88h9KgMnfM/z4Y1ACRVgtu3dnVUSC0ul4/K5YRsGNpLY88h9KgMnfM/z4Y1ACRZftubenVQSC0ul4/K5YRsGNpLY88h9KgMnfM/z4Y1ACRZftubenVQSC0ul4/K5YRsGNpLY88h9KgQIRAAAAAZAUASAKAAA" type="audio/wav">
        </audio>
        <!-- Frame 1: M√†n ch√†o -->
        <div class="welcome-screen" id="welcomeScreen">
            <h1 class="welcome-title">üçÄ H·ª®NG V√çA MAY M·∫ÆN üçÄ</h1>
            <p class="welcome-subtitle">H·ª©ng v√≠a li·ªÅn tay ‚Äì Qu√† hay v·ªÅ ngay!</p>
            <button class="play-btn" onclick="startGame()">üéÆ Ch∆°i ngay</button>
        </div>

        <!-- Frame 2: Game play -->
        <div class="game-screen" id="gameScreen">
            <div class="game-header">
                <div class="score">V√≠a ƒë√£ h·ª©ng: <span id="scoreCount">0</span></div>
                <div class="game-info">
                    <div>Th·ªùi gian: <div class="progress-bar"><div class="progress-fill" id="timeProgress"></div></div></div>
                    <div>V√≠a: <span id="itemCount">0</span></div>
                </div>
            </div>
            <div class="game-area" id="gameArea">
                <div class="clouds"></div>
                <div class="basket" id="basket"></div>
            </div>
        </div>

        <!-- Frame 3: K·∫øt qu·∫£ -->
        <div class="result-screen" id="resultScreen">
            <h2 class="result-title">üéâ Ch√∫c m·ª´ng b·∫°n! üéâ</h2>
            <div class="caught-count" id="finalScore">0</div>
            <div class="gift-box" id="giftBox">üéÅ</div>
            <div class="gift-name" id="giftName">Qu√† may m·∫Øn</div>
            <div class="result-buttons">
                <button class="result-btn" onclick="claimGift()">üéÅ Nh·∫≠n qu√† ngay</button>
                <button class="result-btn" onclick="resetGame()">üîÑ Ch∆°i l·∫°i</button>
            </div>
        </div>
    </div>

    <script>
        let gameState = {
            score: 0,
            isPlaying: false,
            basketPosition: 160,
            gameInterval: null,
            spawnInterval: null,
            gameTime: 0,
            maxGameTime: 25000, // TƒÉng l√™n 25 gi√¢y do nhi·ªÅu v√≠a h∆°n
            luckyItems: [],
            musicEnabled: true,
            soundEnabled: true,
            maxItems: 6, // TƒÉng gi·ªõi h·∫°n ƒë·ªÉ c√≥ nhi·ªÅu v√≠a c√πng l√∫c
            difficulty: 1
        };

        const gifts = {
            0: { name: "Ch√∫c b·∫°n may m·∫Øn l·∫ßn sau!", icon: "üòä", color: "#95a5a6" },
            1: { name: "Qu√† A - Phi·∫øu gi·∫£m gi√° 10%", icon: "üé´", color: "#e74c3c" },
            2: { name: "Qu√† B - Phi·∫øu gi·∫£m gi√° 20%", icon: "üéüÔ∏è", color: "#f39c12" },
            3: { name: "Qu√† C - Phi·∫øu gi·∫£m gi√° 30%", icon: "üèÜ", color: "#f1c40f" },
            4: { name: "Qu√† D - Phi·∫øu gi·∫£m gi√° 40%", icon: "üíé", color: "#9b59b6" },
            5: { name: "Qu√† E - Phi·∫øu gi·∫£m gi√° 50%", icon: "üëë", color: "#2ecc71" }
        };

        // C·∫•u h√¨nh h√¨nh ·∫£nh (c√≥ th·ªÉ thay ƒë·ªïi ƒë∆∞·ªùng d·∫´n)
        const gameImages = {
            luckyItems: [
                // Th√™m ƒë∆∞·ªùng d·∫´n h√¨nh ·∫£nh v√≠a c·ªßa b·∫°n v√†o ƒë√¢y
                // 'images/lucky1.png',
                // 'images/lucky2.png', 
                // 'images/lucky3.png',
                // ... c√≥ th·ªÉ th√™m nhi·ªÅu h√¨nh kh√°c nhau
            ],
            basket: '' // ƒê∆∞·ªùng d·∫´n h√¨nh ·∫£nh gi·ªè h·ª©ng
            // basket: 'images/basket.png'
        };

        const fallAnimations = {
            top: ['fallFromTop'],
            left: ['fallFromLeft', 'fallZigzagFromLeft'],
            right: ['fallFromRight', 'fallZigzagFromRight'],
            center: ['fallFromCenter', 'fallSpiralFromCenter']
        };

        const spawnPositions = ['top', 'left', 'right', 'center'];

        // Audio functions
        function toggleMusic() {
            const bgMusic = document.getElementById('bgMusic');
            const musicBtn = document.getElementById('musicBtn');
            
            gameState.musicEnabled = !gameState.musicEnabled;
            
            if (gameState.musicEnabled) {
                bgMusic.play().catch(e => console.log('Kh√¥ng th·ªÉ ph√°t nh·∫°c:', e));
                musicBtn.textContent = 'üéµ';
                musicBtn.classList.remove('muted');
            } else {
                bgMusic.pause();
                musicBtn.textContent = 'üîá';
                musicBtn.classList.add('muted');
            }
        }

        function toggleSound() {
            const soundBtn = document.getElementById('soundBtn');
            
            gameState.soundEnabled = !gameState.soundEnabled;
            
            if (gameState.soundEnabled) {
                soundBtn.textContent = 'üîä';
                soundBtn.classList.remove('muted');
            } else {
                soundBtn.textContent = 'üîá';
                soundBtn.classList.add('muted');
            }
        }

        function playCatchSound() {
            if (!gameState.soundEnabled) return;
            
            const catchSound = document.getElementById('catchSound');
            catchSound.currentTime = 0; // Reset v·ªÅ ƒë·∫ßu
            catchSound.play().catch(e => console.log('Kh√¥ng th·ªÉ ph√°t √¢m thanh:', e));
        }

        function startGame() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            gameState.isPlaying = true;
            gameState.score = 0;
            gameState.gameTime = 0;
            gameState.luckyItems = [];
            gameState.difficulty = 1;
            gameState.maxItems = 15;
            
            updateScore();
            updateItemCount();
            
            // Ph√°t nh·∫°c n·ªÅn
            if (gameState.musicEnabled) {
                const bgMusic = document.getElementById('bgMusic');
                bgMusic.play().catch(e => console.log('Kh√¥ng th·ªÉ ph√°t nh·∫°c:', e));
            }
            
            // B·∫Øt ƒë·∫ßu spawn v√≠a v·ªõi h·ªá th·ªëng th√¥ng minh
            startSpawning();
            
            // ƒê·∫øm th·ªùi gian game v√† tƒÉng ƒë·ªô kh√≥
            gameState.gameInterval = setInterval(() => {
                gameState.gameTime += 100;
                updateTimeProgress();
                
                // TƒÉng ƒë·ªô kh√≥ m·ªói 3 gi√¢y
                if (gameState.gameTime % 3000 === 0) {
                    increaseDifficulty();
                }
                
                if (gameState.gameTime >= gameState.maxGameTime) {
                    endGame();
                }
            }, 100);
            
            // ƒêi·ªÅu khi·ªÉn gi·ªè h·ª©ng
            setupBasketControl();
        }

        function startSpawning() {
            function massSpawnWave() {
                if (!gameState.isPlaying) return;
                
                // X√≥a c√°c v√≠a c≈© ƒë√£ h·∫øt th·ªùi gian (t·ª± ƒë·ªông cleanup)
                cleanupOldItems();
                
                // Spawn 1 wave nhi·ªÅu v√≠a c√πng l√∫c
                const waveSize = Math.floor(2 + (gameState.difficulty * 1.5)); // 2-6 v√≠a m·ªói wave
                const actualSpawnCount = Math.min(waveSize, gameState.maxItems - gameState.luckyItems.length);
                
                for (let i = 0; i < actualSpawnCount; i++) {
                    setTimeout(() => {
                        if (gameState.isPlaying) {
                            spawnLuckyItem();
                        }
                    }, i * 100); // Delay nh·ªè gi·ªØa c√°c v√≠a trong c√πng 1 wave (100ms)
                }
                
                // T√≠nh th·ªùi gian cho wave ti·∫øp theo
                const baseWaveInterval = Math.max(2000, 4000 - (gameState.difficulty * 200)); // 2-4 gi√¢y gi·ªØa c√°c wave
                const randomVariation = Math.random() * 1000; // ¬±500ms variation
                const nextWaveTime = 300 + randomVariation;
                
                setTimeout(massSpawnWave, nextWaveTime);
            }
            
            // B·∫Øt ƒë·∫ßu wave ƒë·∫ßu ti√™n sau 1 gi√¢y
            setTimeout(massSpawnWave, 1000);
        }

        function cleanupOldItems() {
            gameState.luckyItems = gameState.luckyItems.filter(item => {
                const age = Date.now() - item.spawnTime;
                const maxAge = item.duration * 1000 + 2000; // Duration + 2s buffer
                
                if (age > maxAge && item.element.parentNode) {
                    item.element.remove();
                    return false;
                }
                return true;
            });
            updateItemCount();
        }

        function increaseDifficulty() {
            gameState.difficulty += 0.3;
            gameState.maxItems = Math.min(20, 15 + Math.floor(gameState.difficulty / 2)); // TƒÉng t·ª´ 15 l√™n 20
            
            // Th√¥ng b√°o tƒÉng ƒë·ªô kh√≥ (c√≥ th·ªÉ b·ªè comment ƒë·ªÉ test)
            // console.log(`ƒê·ªô kh√≥: ${gameState.difficulty.toFixed(1)}, Max v√≠a: ${gameState.maxItems}`);
        }

        function updateTimeProgress() {
            const progress = ((gameState.maxGameTime - gameState.gameTime) / gameState.maxGameTime) * 100;
            document.getElementById('timeProgress').style.width = progress + '%';
        }

        function updateItemCount() {
            document.getElementById('itemCount').textContent = gameState.luckyItems.length;
        }

        function spawnLuckyItem() {
            if (!gameState.isPlaying || gameState.luckyItems.length >= gameState.maxItems) return;
            
            const gameArea = document.getElementById('gameArea');
            const luckyItem = document.createElement('div');
            luckyItem.className = 'lucky-item';
            
            // Random v·ªã tr√≠ xu·∫•t hi·ªán
            const spawnPosition = spawnPositions[Math.floor(Math.random() * spawnPositions.length)];
            const gameWidth = gameArea.offsetWidth;
            const gameHeight = gameArea.offsetHeight;
            
            let startX, startY, animationType;
            
            switch(spawnPosition) {
                case 'top':
                    startX = Math.random() * (gameWidth - 50);
                    startY = -50;
                    animationType = fallAnimations.top[Math.floor(Math.random() * fallAnimations.top.length)];
                    break;
                    
                case 'left':
                    startX = -50;
                    startY = Math.random() * (gameHeight / 3);
                    animationType = fallAnimations.left[Math.floor(Math.random() * fallAnimations.left.length)];
                    break;
                    
                case 'right':
                    startX = gameWidth;
                    startY = Math.random() * (gameHeight / 3);
                    animationType = fallAnimations.right[Math.floor(Math.random() * fallAnimations.right.length)];
                    break;
                    
                case 'center':
                    startX = gameWidth / 2 - 25;
                    startY = gameHeight / 4;
                    animationType = fallAnimations.center[Math.floor(Math.random() * fallAnimations.center.length)];
                    break;
            }
            
            luckyItem.style.left = startX + 'px';
            luckyItem.style.top = startY + 'px';
            
            // T√≠nh to√°n th·ªùi gian animation d·ª±a tr√™n ƒë·ªô kh√≥
            const baseDuration = 4;
            const difficultyModifier = Math.max(0.5, 1 - (gameState.difficulty * 0.1)); // Nhanh h∆°n khi kh√≥ h∆°n
            const fallDuration = (baseDuration * difficultyModifier) + (Math.random() * 2);
            
            luckyItem.style.animation = `${animationType} ${fallDuration}s cubic-bezier(0.25, 0.46, 0.45, 0.94)`;
            
            // Ki·ªÉm tra c√≥ h√¨nh ·∫£nh t√πy ch·ªânh kh√¥ng
            if (gameImages.luckyItems.length > 0) {
                const randomImage = gameImages.luckyItems[Math.floor(Math.random() * gameImages.luckyItems.length)];
                luckyItem.style.backgroundImage = `url('${randomImage}')`;
                luckyItem.classList.add('has-image');
                luckyItem.innerHTML = '';
            } else {
                const luckyIcons = ['üçÄ', 'üíé', '‚≠ê', 'üéØ', 'üî•', 'üí∞', 'üéÅ', '‚ú®'];
                const randomIcon = luckyIcons[Math.floor(Math.random() * luckyIcons.length)];
                luckyItem.innerHTML = randomIcon;
                
                const colors = [
                    ['#FFD700', '#FFA500'],
                    ['#FF6B6B', '#FF8E53'],
                    ['#4ECDC4', '#44A08D'],
                    ['#A8EDEA', '#FED6E3'],
                    ['#FFE53B', '#FF2525'],
                    ['#21D4FD', '#B721FF']
                ];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                luckyItem.style.background = `radial-gradient(circle, ${randomColor[0]}, ${randomColor[1]})`;
            }
            
            gameArea.appendChild(luckyItem);
            
            const itemData = {
                element: luckyItem,
                x: startX,
                y: startY,
                spawnPosition: spawnPosition,
                caught: false,
                animation: animationType,
                duration: fallDuration,
                spawnTime: Date.now()
            };
            
            gameState.luckyItems.push(itemData);
            updateItemCount();
            
            // Auto cleanup v·ªõi buffer time
            setTimeout(() => {
                if (luckyItem.parentNode && !itemData.caught) {
                    luckyItem.remove();
                    const index = gameState.luckyItems.indexOf(itemData);
                    if (index > -1) {
                        gameState.luckyItems.splice(index, 1);
                    updateItemCount();
                        updateItemCount();
                    }
                }
            }, fallDuration * 1000 + 1000);
        }

        function setupBasketControl() {
            const gameContainer = document.querySelector('.game-container');
            const basket = document.getElementById('basket');
            
            let isMouseDown = false;
            
            // Mouse events
            gameContainer.addEventListener('mousedown', (e) => {
                if (!gameState.isPlaying) return;
                isMouseDown = true;
                updateBasketPosition(e);
            });
            
            gameContainer.addEventListener('mousemove', (e) => {
                if (!gameState.isPlaying || !isMouseDown) return;
                updateBasketPosition(e);
            });
            
            gameContainer.addEventListener('mouseup', () => {
                isMouseDown = false;
            });
            
            // Touch events
            gameContainer.addEventListener('touchstart', (e) => {
                if (!gameState.isPlaying) return;
                e.preventDefault();
                updateBasketPosition(e.touches[0]);
            });
            
            gameContainer.addEventListener('touchmove', (e) => {
                if (!gameState.isPlaying) return;
                e.preventDefault();
                updateBasketPosition(e.touches[0]);
            });
            
            // Collision detection
            setInterval(checkCollisions, 16); // ~60fps
        }

        function updateBasketPosition(event) {
            const gameContainer = document.querySelector('.game-container');
            const basket = document.getElementById('basket');
            const rect = gameContainer.getBoundingClientRect();
            
            const x = event.clientX - rect.left;
            const basketWidth = basket.offsetWidth;
            const maxX = gameContainer.offsetWidth - basketWidth;
            
            gameState.basketPosition = Math.max(0, Math.min(maxX, x - basketWidth / 2));
            basket.style.left = gameState.basketPosition + 'px';
        }

        function checkCollisions() {
            if (!gameState.isPlaying) return;
            
            const basket = document.getElementById('basket');
            const basketRect = basket.getBoundingClientRect();
            const gameContainer = document.querySelector('.game-container');
            const gameRect = gameContainer.getBoundingClientRect();
            
            gameState.luckyItems.forEach((item, index) => {
                if (item.caught) return;
                
                const itemRect = item.element.getBoundingClientRect();
                
                // Ki·ªÉm tra va ch·∫°m
                if (itemRect.bottom >= basketRect.top &&
                    itemRect.top <= basketRect.bottom &&
                    itemRect.right >= basketRect.left &&
                    itemRect.left <= basketRect.right) {
                    
                    // ƒê√£ h·ª©ng ƒë∆∞·ª£c
                    item.caught = true;
                    gameState.score++;
                    updateScore();
                    
                    // Ph√°t √¢m thanh khi h·ª©ng ƒë∆∞·ª£c
                    playCatchSound();
                    
                    // Hi·ªáu ·ª©ng khi h·ª©ng ƒë∆∞·ª£c
                    item.element.style.animation = 'none';
                    item.element.style.transform = 'scale(1.5)';
                    item.element.style.transition = 'transform 0.2s ease';
                    item.element.style.zIndex = '10';
                    
                    // Hi·ªáu ·ª©ng sparkle
                    setTimeout(() => {
                        item.element.style.transform = 'scale(0)';
                    }, 100);
                    
                    setTimeout(() => {
                        if (item.element.parentNode) {
                            item.element.remove();
                        }
                    }, 300);
                    
                    gameState.luckyItems.splice(index, 1);
                }
            });
        }

        function updateScore() {
            document.getElementById('scoreCount').textContent = gameState.score;
        }

        function endGame() {
            gameState.isPlaying = false;
            clearInterval(gameState.gameInterval);
            
            // D·ª´ng nh·∫°c n·ªÅn
            const bgMusic = document.getElementById('bgMusic');
            bgMusic.pause();
            bgMusic.currentTime = 0;
            
            // X√≥a t·∫•t c·∫£ v√≠a c√≤n l·∫°i v·ªõi hi·ªáu ·ª©ng
            gameState.luckyItems.forEach((item, index) => {
                setTimeout(() => {
                    if (item.element.parentNode) {
                        item.element.style.animation = 'none';
                        item.element.style.transform = 'scale(0) rotate(180deg)';
                        item.element.style.transition = 'transform 0.5s ease';
                        setTimeout(() => {
                            item.element.remove();
                        }, 500);
                    }
                }, index * 50); // Stagger effect
            });
            
            gameState.luckyItems = [];
            updateItemCount();
            
            setTimeout(() => {
                showResult();
            }, 1000);
        }

        function showResult() {
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'flex';
            
            const finalScore = Math.min(gameState.score, 5); // T·ªëi ƒëa 5 v√≠a
            document.getElementById('finalScore').textContent = finalScore;
            
            const gift = gifts[finalScore];
            document.getElementById('giftBox').textContent = gift.icon;
            document.getElementById('giftBox').style.background = `linear-gradient(45deg, ${gift.color}, #FF8E53)`;
            document.getElementById('giftName').textContent = gift.name;
        }

        function claimGift() {
            const gift = gifts[Math.min(gameState.score, 5)];
            alert(`üéâ B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c: ${gift.name}!`);
            
            // ·ªû ƒë√¢y b·∫°n c√≥ th·ªÉ g·ªçi API Laravel ƒë·ªÉ l∆∞u ph·∫ßn qu√†
            // fetch('/api/claim-gift', { method: 'POST', ... })
        }

        function resetGame() {
            // Reset game state
            const currentMusicEnabled = gameState.musicEnabled;
            const currentSoundEnabled = gameState.soundEnabled;
            
            gameState = {
                score: 0,
                isPlaying: false,
                basketPosition: 160,
                gameInterval: null,
                spawnInterval: null,
                gameTime: 0,
                maxGameTime: 20000,
                luckyItems: [],
                musicEnabled: currentMusicEnabled,
                soundEnabled: currentSoundEnabled,
                spawnRate: 600,
                maxItems: 8,
                difficulty: 1
            };
            
            // Hi·ªÉn th·ªã l·∫°i m√†n ch√†o
            document.getElementById('resultScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'flex';
            
            // Reset basket position
            const basket = document.getElementById('basket');
            basket.style.left = '160px';
        }

        // Kh·ªüi t·∫°o v·ªã tr√≠ gi·ªè h·ª©ng ban ƒë·∫ßu v√† thi·∫øt l·∫≠p h√¨nh ·∫£nh
        window.addEventListener('load', () => {
            const basket = document.getElementById('basket');
            basket.style.left = gameState.basketPosition + 'px';
            
            // Thi·∫øt l·∫≠p h√¨nh ·∫£nh gi·ªè h·ª©ng n·∫øu c√≥
            if (gameImages.basket) {
                basket.style.backgroundImage = `url('${gameImages.basket}')`;
                basket.classList.add('has-image');
            }
        });
    </script>
</body>
</html>